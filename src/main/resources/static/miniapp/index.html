<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Telegram Music Cloud</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
/* ==== –°–¢–ò–õ–ò –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô ==== */
body { margin:0; background:#0f0f0f; font-family:Arial,sans-serif; color:#fff; }
.header { display:flex; justify-content:space-between; align-items:center; padding:16px 20px; background:#1a1a1a; border-bottom:1px solid #333; }
.header-title { font-size:22px; font-weight:bold; }
.search-box input { padding:8px 12px; border-radius:6px; border:none; background:#222; color:#fff; }
.layout { padding:15px; }
.library-menu { display:flex; gap:10px; margin-bottom:15px; }
.menu-btn { background:#1e1e1e; border:1px solid #333; color:#aaa; padding:8px 16px; border-radius:20px; cursor:pointer; }
.menu-btn.active { background:#fff; color:#000; }
.songs-container { background:#121212; border-radius:12px; padding:10px; }
.track-item { display:grid; grid-template-columns:30px 1fr auto auto; gap:12px; padding:12px; border-radius:10px; cursor:pointer; }
.track-item:hover { background:#1b1b1b; }
.track-title { font-size:14px; font-weight:600; }
.track-artist { font-size:12px; color:#aaa; }
.play-btn { width:36px; height:36px; border-radius:50%; border:1px solid #555; background:none; color:white; cursor:pointer; }
.more-btn { background:none; border:none; color:#aaa; font-size:20px; cursor:pointer; }
.context-menu { position:fixed; z-index:9999; min-width:200px; background:#1f1f1f; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.6); padding:6px; }
.context-menu button { width:100%; background:none; border:none; color:white; padding:10px 12px; text-align:left; border-radius:8px; cursor:pointer; }
.context-menu button:hover { background:#2a2a2a; }
.context-menu.hidden { display:none; }
.mini-player { position:fixed; bottom:0; left:0; width:100%; background:#1b1b1b; border-top:1px solid #333; padding:10px 15px; }
.mini-player.hidden { display:none; }
.mini-title { font-size:14px; font-weight:600; margin-bottom:8px; }
.controls { display:flex; justify-content:center; align-items:center; gap:26px; font-size:30px; margin-bottom:8px; }
.ctrl-btn { background:none; border:none; color:white; cursor:pointer; }
.progress { display:flex; align-items:center; gap:8px; font-size:12px; color:#aaa; }
.progress input { flex:1; max-width:65%; }
.view { display:none; }
.view.active { display:block; }
#audio-player { display:none; }
</style>
</head>

<body>

<div class="header">
    <div class="header-title">Telegram Music Cloud</div>
    <div class="search-box"><input placeholder="–ü–æ–∏—Å–∫..."></div>
</div>

<div class="layout">
<div class="songs-container">

<div class="library-menu">
    <button class="menu-btn active" id="btn-library">üéµ –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞</button>
    <button class="menu-btn" id="btn-playlists">üìÇ –ü–ª–µ–π–ª–∏—Å—Ç—ã</button>
</div>

<div id="library-view" class="view active">
    <div id="track-list"></div>
</div>

<div id="playlists-view" class="view">
    <div id="playlists-grid"></div>
    <div id="playlist-detail" style="display:none">
        <button id="playlist-back-btn">‚Üê –ù–∞–∑–∞–¥</button>
        <h3 id="playlist-detail-title"></h3>
        <div id="playlist-track-list"></div>
    </div>
</div>

</div>
</div>

<div class="mini-player hidden" id="mini-player">
    <div class="mini-title" id="mini-title"></div>
    <div class="controls">
        <button class="ctrl-btn" id="prev">‚èÆ</button>
        <button class="ctrl-btn" id="play">‚ñ∂</button>
        <button class="ctrl-btn" id="next">‚è≠</button>
    </div>
</div>

<div id="context-menu" class="context-menu hidden">
    <button id="delete-track">üóë –£–¥–∞–ª–∏—Ç—å</button>
</div>

<audio id="audio-player"></audio>

<script>
const tg = window.Telegram.WebApp;
tg.ready(); tg.expand();

const apiBase = "https://telegram-music-player-uh5o.onrender.com";
const audio = document.getElementById("audio-player");

let libraryTracks = [];
let activeTracks = [];
let currentIndex = -1;

const trackListDiv = document.getElementById("track-list");
const miniPlayer = document.getElementById("mini-player");
const miniTitle = document.getElementById("mini-title");

async function loadTracks() {
    const r = await fetch(`${apiBase}/api/tracks`, {
        headers: { "X-TG-INIT-DATA": tg.initData }
    });
    libraryTracks = await r.json();
    renderLibrary();
}

function renderLibrary() {
    trackListDiv.innerHTML = "";
    libraryTracks.forEach((t, i) => {
        const div = document.createElement("div");
        div.className = "track-item";
        div.innerHTML = `
            <span>${i+1}</span>
            <div>
                <div class="track-title">${t.originalName}</div>
                <div class="track-artist">${t.performer || "Unknown"}</div>
            </div>
            <button class="play-btn">
                ${activeTracks === libraryTracks && i === currentIndex && !audio.paused ? "‚è∏" : "‚ñ∂"}
            </button>
            <button class="more-btn">‚ãØ</button>
        `;
        div.onclick = () => playFromLibrary(i);
        div.querySelector(".play-btn").onclick = e => {
            e.stopPropagation();
            playFromLibrary(i);
        };
        trackListDiv.appendChild(div);
    });
}

async function playFromLibrary(i) {
    activeTracks = libraryTracks;
    playTrack(i);
}

async function playFromPlaylist(list, i) {
    activeTracks = list;
    playTrack(i);
}

async function playTrack(i) {
    currentIndex = i;
    const r = await fetch(`${apiBase}/api/tracks/play/${activeTracks[i].id}`, {
        headers: { "X-TG-INIT-DATA": tg.initData }
    });
    const data = await r.json();
    audio.src = data.streamUrl;
    await audio.play();
    miniTitle.innerText = activeTracks[i].originalName;
    miniPlayer.classList.remove("hidden");
    renderLibrary();
}

document.getElementById("play").onclick = () => {
    audio.paused ? audio.play() : audio.pause();
    renderLibrary();
};
document.getElementById("next").onclick = () => {
    if (currentIndex < activeTracks.length - 1) playTrack(currentIndex + 1);
};
document.getElementById("prev").onclick = () => {
    if (currentIndex > 0) playTrack(currentIndex - 1);
};

loadTracks();
</script>

</body>
</html>
