<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="color-scheme" content="dark">
    <title>Telegram Music Cloud</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: #0f0f0f;
            --panel-color: #1a1a1a;
            --text-main: #ffffff;
            --text-dim: #aaaaaa;
            --accent: #ffffff;
        }

        html, body {
            margin: 0; padding: 0;
            width: 100%; min-height: 100vh;
            background: var(--bg-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            color: var(--text-main);
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* HEADER */
        .header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px 20px; background: var(--panel-color);
            border-bottom: 1px solid #333; position: sticky; top: 0; z-index: 100;
        }
        .header-title { font-size: 18px; font-weight: bold; }
        .search-box input {
            padding: 8px 12px; border-radius: 8px; border: none;
            background: #222; color: #fff; width: 120px;
        }

        /* LAYOUT */
        .layout { padding: 15px; padding-bottom: 120px; }

        /* MENU */
        .library-menu { display: flex; gap: 10px; margin-bottom: 15px; }
        .menu-btn {
            background: #1e1e1e; border: 1px solid #333; color: var(--text-dim);
            padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 14px;
        }
        .menu-btn.active { background: #fff; color: #000; border-color: #fff; }

        /* TRACK LIST & GRID FIX */
        .track-item {
            display: grid;
            /* –§–∏–∫—Å–∏—Ä—É–µ–º –∫–æ–ª–æ–Ω–∫–∏: –Ω–æ–º–µ—Ä, –∫–æ–Ω—Ç–µ–Ω—Ç, –∫–Ω–æ–ø–∫–∞, –æ–ø—Ü–∏–∏ */
            grid-template-columns: 30px 1fr 45px 35px;
            align-items: center;
            gap: 10px;
            padding: 12px 8px;
            border-radius: 10px;
            overflow: hidden;
        }
        .track-item:active { background: #1b1b1b; }

        .track-title-cell {
            min-width: 0; /* –í–∞–∂–Ω–æ –¥–ª—è —Ä–∞–±–æ—Ç—ã overflow –≤ grid */
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .track-title-wrap {
            width: 100%;
            overflow: hidden;
            white-space: nowrap;
            position: relative;
        }

        /* MARQUEE LOGIC */
        .track-title-wrap.marquee-active {
            display: flex;
            width: max-content;
            animation: scroll-text 10s linear infinite;
        }
        .track-title-wrap.marquee-active .track-title {
            padding-right: 50px;
        }

        @keyframes scroll-text {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }

        .track-title { font-size: 14px; font-weight: 600; }
        .track-artist { font-size: 12px; color: var(--text-dim); margin-top: 2px; }

        /* BUTTONS & MONOCHROME */
        .play-btn {
            width: 36px; height: 36px; border-radius: 50%;
            border: 1px solid #444; background: #2a2a2a;
            color: #fff; font-size: 14px; display: flex;
            align-items: center; justify-content: center;
            filter: grayscale(1) brightness(1.5);
        }
        .more-btn, .ctrl-btn {
            background: none; border: none; color: var(--text-dim);
            font-size: 20px; cursor: pointer;
            filter: grayscale(1) brightness(1.5);
        }

        /* MINI PLAYER FIX */
        #mini-player {
            position: fixed !important;
            bottom: 0 !important; left: 0 !important; right: 0 !important;
            background: #1b1b1b !important;
            border-top: 1px solid #333 !important;
            padding: 12px 16px !important;
            padding-bottom: calc(12px + env(safe-area-inset-bottom)) !important;
            display: flex; flex-direction: column; gap: 10px;
            z-index: 1000;
        }
        .mini-title { 
            font-size: 14px; text-align: center; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
        }
        .controls { display: flex; justify-content: center; align-items: center; gap: 30px; }
        .progress { display: flex; align-items: center; gap: 10px; font-size: 11px; color: #888; }
        .progress input { flex: 1; accent-color: #fff; height: 4px; }

        .hidden { display: none !important; }

        /* MODALS & CONTEXT */
        .context-menu {
            position: fixed; z-index: 10001; background: #252525;
            border-radius: 12px; padding: 5px; min-width: 180px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.5);
        }
        .context-menu button {
            width: 100%; padding: 12px; text-align: left; background: none;
            border: none; color: white; border-radius: 8px;
        }
    </style>
</head>
<body>

<div class="header">
    <div class="header-title">Music Cloud</div>
    <div class="search-box"><input type="text" placeholder="–ü–æ–∏—Å–∫..."></div>
</div>

<div class="layout">
    <div class="library-menu">
        <button class="menu-btn active" id="btn-library">üéµ –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞</button>
        <button class="menu-btn" id="btn-playlists">üìÇ –ü–ª–µ–π–ª–∏—Å—Ç—ã</button>
    </div>

    <div id="library-view" class="view active">
        <div id="track-list"></div>
    </div>
    
    <div id="playlists-view" class="view hidden">
        <div id="playlists-grid"></div>
    </div>
</div>

<div id="mini-player" class="hidden">
    <div class="mini-title" id="mini-title">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç—Ä–µ–∫–∞</div>
    <div class="controls">
        <button class="ctrl-btn" id="repeat" style="font-size:18px; opacity:0.5">üîÅ</button>
        <button class="ctrl-btn" id="prev">‚èÆ</button>
        <button class="ctrl-btn" id="play" style="font-size:32px">‚ñ∂</button>
        <button class="ctrl-btn" id="next">‚è≠</button>
        <button class="ctrl-btn" id="mini-more">‚ãØ</button>
    </div>
    <div class="progress">
        <span id="current">0:00</span>
        <input type="range" id="progress" value="0" min="0" step="0.1">
        <span id="duration">0:00</span>
    </div>
</div>

<div id="context-menu" class="context-menu hidden">
    <button id="add-to-playlist-btn">‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤ –ø–ª–µ–π–ª–∏—Å—Ç</button>
    <button id="delete-track" style="color: #ff4444;">üóë –£–¥–∞–ª–∏—Ç—å</button>
</div>

<audio id="audio-player"></audio>

<script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();
    tg.headerColor = '#1a1a1a';

    const apiBase = "https://telegram-music-player-uh5o.onrender.com";
    const audio = document.getElementById("audio-player");
    let tracks = [];
    let currentIndex = -1;

    async function loadTracks() {
        try {
            const r = await fetch(`${apiBase}/api/tracks`, {
                headers: { "X-TG-INIT-DATA": tg.initData }
            });
            tracks = await r.json();
            renderTracks();
        } catch (e) { console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏", e); }
    }

    function renderTracks() {
        const container = document.getElementById("track-list");
        container.innerHTML = "";
        
        tracks.forEach((t, i) => {
            const div = document.createElement("div");
            div.className = "track-item";
            const name = t.originalName || "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è";
            
            // –õ–æ–≥–∏–∫–∞ –±–µ–≥—É—â–µ–π —Å—Ç—Ä–æ–∫–∏: –µ—Å–ª–∏ –±–æ–ª—å—à–µ 20 —Å–∏–º–≤–æ–ª–æ–≤
            const isLong = name.length > 20;
            const titleContent = isLong 
                ? `<div class="track-title-wrap marquee-active"><span class="track-title">${name}</span><span class="track-title">${name}</span></div>`
                : `<div class="track-title-wrap"><span class="track-title">${name}</span></div>`;

            div.innerHTML = `
                <div style="color:#666; font-size:12px">${i + 1}</div>
                <div class="track-title-cell">
                    ${titleContent}
                    <div class="track-artist">${t.performer || 'Unknown'}</div>
                </div>
                <button class="play-btn">${currentIndex === i && !audio.paused ? '‚è∏' : '‚ñ∂'}</button>
                <button class="more-btn">‚ãØ</button>
            `;
            
            div.querySelector(".play-btn").onclick = (e) => {
                e.stopPropagation();
                playTrack(i);
            };
            div.querySelector(".more-btn").onclick = (e) => {
                e.stopPropagation();
                showContext(e.clientX, e.clientY, t.id);
            };
            container.appendChild(div);
        });
    }

    async function playTrack(i) {
        if (currentIndex === i) {
            if (audio.paused) audio.play(); else audio.pause();
        } else {
            currentIndex = i;
            const track = tracks[i];
            const r = await fetch(`${apiBase}/api/tracks/play/${track.id}`, {
                headers: { "X-TG-INIT-DATA": tg.initData }
            });
            const data = await r.json();
            audio.src = data.streamUrl;
            audio.play();
            document.getElementById("mini-title").innerText = track.originalName;
            document.getElementById("mini-player").classList.remove("hidden");
        }
        updateUI();
    }

    function updateUI() {
        document.getElementById("play").innerText = audio.paused ? "‚ñ∂" : "‚è∏";
        renderTracks();
    }

    function showContext(x, y, id) {
        const menu = document.getElementById("context-menu");
        menu.style.top = y + "px";
        menu.style.left = (x - 150) + "px";
        menu.classList.remove("hidden");
        
        document.onclick = () => menu.classList.add("hidden");
    }

    // Audio Events
    audio.ontimeupdate = () => {
        const p = document.getElementById("progress");
        p.max = audio.duration || 0;
        p.value = audio.currentTime;
        document.getElementById("current").innerText = formatTime(audio.currentTime);
        document.getElementById("duration").innerText = formatTime(audio.duration);
    };

    function formatTime(s) {
        if (!s) return "0:00";
        const m = Math.floor(s / 60);
        const sec = Math.floor(s % 60).toString().padStart(2, "0");
        return `${m}:${sec}`;
    }

    document.getElementById("play").onclick = () => {
        if (audio.paused) audio.play(); else audio.pause();
        updateUI();
    };

    loadTracks();
</script>
</body>
</html>