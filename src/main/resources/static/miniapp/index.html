<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Telegram Music Cloud</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        html, body {
            margin: 0; padding: 0; width: 100%; overflow-x: hidden;
            background: #0f0f0f; font-family: -apple-system, system-ui, sans-serif;
            color: #fff; -webkit-text-size-adjust: 100%;
        }
        body { min-height: 100vh; }

        /* HEADER */
        .header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px 20px; background: #1a1a1a; border-bottom: 1px solid #333;
        }
        .header-title { font-size: 20px; font-weight: bold; display: flex; align-items: center; gap: 6px; }
        .app-version { font-size: 11px; color: #666; font-weight: normal; }
        .search-box input {
            padding: 8px 12px; border-radius: 6px; border: none;
            background: #222; color: #fff; width: 100px;
        }

        /* LAYOUT & MENU */
        .layout { padding: 15px; padding-bottom: 120px; }
        .library-menu { display: flex; gap: 10px; margin-bottom: 15px; }
        .menu-btn {
            background: #1e1e1e; border: 1px solid #333; color: #aaa;
            padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 14px;
        }
        .menu-btn.active { background: #fff; color: #000; border-color: #fff; }

        /* TRACK LIST */
        .songs-container { background: #121212; border-radius: 12px; padding: 5px; }
        .track-item {
            display: grid; grid-template-columns: 30px 1fr auto auto;
            gap: 12px; padding: 12px; border-radius: 10px; align-items: center;
        }
        .track-item:active { background: #1b1b1b; }
        .track-title-cell { min-width: 0; overflow: hidden; }
        .track-title { font-size: 14px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .track-artist { font-size: 12px; color: #aaa; margin-top: 2px; }

        .play-btn {
            width: 36px; height: 36px; border-radius: 50%; border: 1px solid #555;
            background: #2a2a2a; color: #fff; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }

        /* MINI PLAYER (–°–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) */
        .mini-player {
            position: fixed !important; bottom: 0; left: 0; right: 0;
            background: #1b1b1b !important; border-top: 1px solid #333;
            padding: 12px 16px; z-index: 1000;
            display: flex; flex-direction: column; gap: 8px;
            padding-bottom: calc(12px + env(safe-area-inset-bottom));
        }
        .mini-player.hidden { display: none !important; }

        .mini-title { font-size: 14px; font-weight: 600; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* CONTROLS (–°–∏–º–º–µ—Ç—Ä–∏—á–Ω—ã–µ) */
        .controls { display: flex; justify-content: center; align-items: center; gap: 24px; }
        .ctrl-btn {
            background: transparent; border: none; color: #fff; cursor: pointer; padding: 5px;
            display: flex; align-items: center; justify-content: center;
        }
        .ctrl-btn svg { width: 28px; height: 28px; fill: currentColor; }
        
        .ctrl-btn-play-circle {
            width: 48px; height: 48px; border-radius: 50%; background: #333 !important;
        }
        .ctrl-btn-play-circle svg { width: 24px; height: 24px; }

        /* PROGRESS */
        .progress { display: flex; align-items: center; gap: 10px; font-size: 11px; color: #aaa; }
        .progress input { flex: 1; accent-color: #fff; height: 4px; }

        /* MODALS & CONTEXT */
        .context-menu {
            position: fixed; z-index: 9999; min-width: 180px;
            background: #1f1f1f; border-radius: 12px; padding: 6px;
            box-shadow: 0 10px 30px rgba(0,0,0,.6);
        }
        .context-menu button {
            width: 100%; background: none; border: none; color: white;
            padding: 10px; text-align: left; border-radius: 8px;
        }
        .hidden { display: none !important; }

        /* GRID –ü–õ–ï–ô–õ–ò–°–¢–û–í */
        .view { display: none; }
        .view.active { display: block; }
        .playlists-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .playlist-card {
            background: #1a1a1a; border-radius: 12px; aspect-ratio: 1/1;
            display: flex; align-items: center; justify-content: center;
            border: 1px solid #333; position: relative; font-weight: bold;
        }

        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,.8);
            display: flex; align-items: center; justify-content: center; z-index: 10001;
        }
        .modal-dialog { background: #1f1f1f; padding: 20px; border-radius: 15px; width: 80%; }
        .modal-dialog input { width: 100%; padding: 10px; margin-top: 10px; background: #111; border: 1px solid #444; color: #fff; border-radius: 5px; box-sizing: border-box; }
        .modal-buttons { display: flex; gap: 10px; margin-top: 15px; }
        .modal-buttons button { flex: 1; padding: 10px; border-radius: 5px; border: none; font-weight: bold; }
    </style>
</head>
<body>

<div class="header">
    <div class="header-title">Music Cloud <span class="app-version">v2.1</span></div>
    <div class="search-box"><input type="text" placeholder="–ü–æ–∏—Å–∫..."></div>
</div>

<div class="layout">
    <div class="library-menu">
        <button class="menu-btn active" id="btn-library">üéµ –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞</button>
        <button class="menu-btn" id="btn-playlists">üìÇ –ü–ª–µ–π–ª–∏—Å—Ç—ã</button>
    </div>

    <div id="library-view" class="view active">
        <div class="songs-container" id="track-list"></div>
    </div>

    <div id="playlists-view" class="view">
        <div id="playlists-grid" class="playlists-grid">
            <div class="playlist-card" id="create-playlist">‚ûï –ù–æ–≤—ã–π</div>
        </div>
        <div id="playlist-detail" class="view" style="margin-top:20px">
            <button id="playlist-back-btn" style="background:none; border:none; color:#aaa; margin-bottom:10px">‚Üê –ù–∞–∑–∞–¥</button>
            <h3 id="playlist-detail-title"></h3>
            <div id="playlist-track-list"></div>
        </div>
    </div>
</div>

<div class="mini-player hidden" id="mini-player">
    <div class="mini-title" id="mini-title">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    <div class="controls">
        <button class="ctrl-btn" id="repeat"><svg viewBox="0 0 24 24"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z"/></svg></button>
        
        <button class="ctrl-btn" id="prev"><svg viewBox="0 0 24 24"><path d="M6 6h2v12H6V6zm3.5 6l8.5 6V6l-8.5 6z"/></svg></button>
        
        <button class="ctrl-btn ctrl-btn-play-circle" id="play"><span id="play-btn-icon"></span></button>
        
        <button class="ctrl-btn" id="next"><svg viewBox="0 0 24 24"><path d="M18 6h-2v12h2V6zm-3.5 6L6 6v12l8.5-6z" transform="rotate(180 12 12)"/></svg></button>
        
        <button class="ctrl-btn" id="mini-more"><svg viewBox="0 0 24 24"><circle cx="12" cy="6" r="1.5"/><circle cx="12" cy="12" r="1.5"/><circle cx="12" cy="18" r="1.5"/></svg></button>
    </div>
    <div class="progress">
        <span id="current">0:00</span>
        <input type="range" id="progress" value="0" min="0" step="0.1">
        <span id="duration">0:00</span>
    </div>
</div>

<div id="context-menu" class="context-menu hidden">
    <button id="add-to-playlist-btn">‚ûï –í –ø–ª–µ–π–ª–∏—Å—Ç</button>
    <button id="delete-track" style="color:#ff4444">üóë –£–¥–∞–ª–∏—Ç—å</button>
</div>

<div id="playlist-modal" class="modal-overlay hidden">
    <div class="modal-dialog">
        <h3>–ù–æ–≤—ã–π –ø–ª–µ–π–ª–∏—Å—Ç</h3>
        <input type="text" id="playlist-name-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ...">
        <div class="modal-buttons">
            <button id="playlist-modal-cancel" style="background:#333; color:#fff">–û—Ç–º–µ–Ω–∞</button>
            <button id="playlist-modal-confirm" style="background:#fff; color:#000">–°–æ–∑–¥–∞—Ç—å</button>
        </div>
    </div>
</div>

<audio id="audio-player"></audio>

<script>
const tg = window.Telegram.WebApp;
tg.ready();
tg.expand();

const apiBase = "https://telegram-music-player-uh5o.onrender.com";
const audio = document.getElementById("audio-player");
const miniPlayer = document.getElementById("mini-player");

const iconPlay = '<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7L8 5z"/></svg>';
const iconPause = '<svg viewBox="0 0 24 24"><path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/></svg>';

let tracks = [];
let currentIndex = -1;
let playbackQueue = [];
let repeat = false;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–Ω–æ–ø–æ–∫ –ø–ª–µ–µ—Ä–∞
document.getElementById("play-btn-icon").innerHTML = iconPlay;

async function loadTracks() {
    const r = await fetch(`${apiBase}/api/tracks`, { headers: { "X-TG-INIT-DATA": tg.initData } });
    tracks = await r.json();
    renderTracks();
}

function renderTracks() {
    const list = document.getElementById("track-list");
    list.innerHTML = tracks.map((t, i) => `
        <div class="track-item" onclick="playTrack(${i})">
            <span style="color:#666; font-size:12px">${i+1}</span>
            <div class="track-title-cell">
                <div class="track-title">${t.originalName || 'Track'}</div>
                <div class="track-artist">${t.performer || 'Unknown'}</div>
            </div>
            <button class="play-btn">${currentIndex === i && !audio.paused ? iconPause : iconPlay}</button>
            <button class="ctrl-btn" onclick="event.stopPropagation(); showMenu(event, ${t.id})">‚ãÆ</button>
        </div>
    `).join('');
}

async function playTrack(i, queue) {
    playbackQueue = queue || tracks;
    currentIndex = i;
    const track = playbackQueue[i];
    
    const r = await fetch(`${apiBase}/api/tracks/play/${track.id}`, { headers: { "X-TG-INIT-DATA": tg.initData } });
    const data = await r.json();
    
    audio.src = data.streamUrl;
    audio.play();

    // –ü–û–Ø–í–õ–ï–ù–ò–ï –ü–õ–ï–ï–†–ê
    miniPlayer.classList.remove("hidden");
    document.getElementById("mini-title").innerText = track.originalName;
    updateUI();
}

function updateUI() {
    document.getElementById("play-btn-icon").innerHTML = audio.paused ? iconPlay : iconPause;
    renderTracks();
}

// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞—É–¥–∏–æ
document.getElementById("play").onclick = () => {
    if (audio.paused) audio.play(); else audio.pause();
    updateUI();
};

document.getElementById("next").onclick = () => {
    if (currentIndex < playbackQueue.length - 1) playTrack(currentIndex + 1, playbackQueue);
};

document.getElementById("prev").onclick = () => {
    if (currentIndex > 0) playTrack(currentIndex - 1, playbackQueue);
};

audio.ontimeupdate = () => {
    const prog = document.getElementById("progress");
    prog.max = audio.duration || 0;
    prog.value = audio.currentTime;
    document.getElementById("current").innerText = formatTime(audio.currentTime);
    document.getElementById("duration").innerText = formatTime(audio.duration);
};

function formatTime(s) {
    const m = Math.floor(s / 60);
    const sec = Math.floor(s % 60).toString().padStart(2, '0');
    return `${m}:${sec}`;
}

// –ü–ª–µ–π–ª–∏—Å—Ç—ã –∏ –ù–∞–≤–∏–≥–∞—Ü–∏—è
document.getElementById("btn-library").onclick = () => switchView("library");
document.getElementById("btn-playlists").onclick = () => switchView("playlists");

function switchView(v) {
    document.getElementById("library-view").classList.toggle("active", v === "library");
    document.getElementById("playlists-view").classList.toggle("active", v === "playlists");
    document.getElementById("btn-library").classList.toggle("active", v === "library");
    document.getElementById("btn-playlists").classList.toggle("active", v === "playlists");
}

document.getElementById("create-playlist").onclick = () => {
    document.getElementById("playlist-modal").classList.remove("hidden");
};

document.getElementById("playlist-modal-cancel").onclick = () => {
    document.getElementById("playlist-modal").classList.add("hidden");
};

document.getElementById("playlist-modal-confirm").onclick = async () => {
    const name = document.getElementById("playlist-name-input").value;
    if (name) {
        await fetch(`${apiBase}/api/playlists`, {
            method: "POST",
            headers: { "Content-Type": "application/json", "X-TG-INIT-DATA": tg.initData },
            body: JSON.stringify({ name })
        });
        document.getElementById("playlist-modal").classList.add("hidden");
        // –¢—É—Ç –º–æ–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫—É –ø–ª–µ–π–ª–∏—Å—Ç–æ–≤
    }
};

loadTracks();
</script>
</body>
</html>