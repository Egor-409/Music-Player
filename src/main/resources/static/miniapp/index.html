<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Telegram Music Cloud</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
body {
    margin:0;
    background:#0f0f0f;
    font-family:Arial,sans-serif;
    color:#fff;
}

/* HEADER */
.header {
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:16px 20px;
    background:#1a1a1a;
    border-bottom:1px solid #333;
}
.header-title { font-size:22px; font-weight:bold; }
.search-box input {
    padding:8px 12px;
    border-radius:6px;
    border:none;
    background:#222;
    color:#fff;
}

/* LAYOUT */
.layout { padding:15px; }

/* MENU */
.library-menu {
    display:flex;
    gap:10px;
    margin-bottom:15px;
}
.menu-btn {
    background:#1e1e1e;
    border:1px solid #333;
    color:#aaa;
    padding:8px 16px;
    border-radius:20px;
    cursor:pointer;
}
.menu-btn.active {
    background:#fff;
    color:#000;
}

/* TRACK LIST */
.songs-container {
    background:#121212;
    border-radius:12px;
    padding:10px;
}

.track-item {
    display:grid;
    grid-template-columns:30px 1fr auto auto;
    gap:12px;
    padding:12px;
    border-radius:10px;
    cursor:pointer;
}
.track-item:hover { background:#1b1b1b; }

.track-title { font-size:14px; font-weight:600; }
.track-artist { font-size:12px; color:#aaa; }

.play-btn {
    width:36px;
    height:36px;
    border-radius:50%;
    border:1px solid #555;
    background:none;
    color:white;
    cursor:pointer;
}

.more-btn {
    background:none;
    border:none;
    color:#aaa;
    font-size:20px;
    cursor:pointer;
}

/* CONTEXT MENU */
.context-menu {
    position:fixed;
    z-index:9999;
    min-width:200px;
    background:#1f1f1f;
    border-radius:12px;
    box-shadow:0 10px 30px rgba(0,0,0,.6);
    padding:6px;
}
.context-menu button {
    width:100%;
    background:none;
    border:none;
    color:white;
    padding:10px 12px;
    text-align:left;
    border-radius:8px;
    cursor:pointer;
}
.context-menu button:hover { background:#2a2a2a; }
.context-menu.hidden { display:none; }

/* MINI PLAYER */
.mini-player {
    position:fixed;
    bottom:0;
    left:0;
    width:100%;
    background:#1b1b1b;
    border-top:1px solid #333;
    padding:10px 15px;
}
.mini-player.hidden { display:none; }

.mini-title {
    font-size:14px;
    font-weight:600;
    margin-bottom:8px;
}

/* CONTROLS */
.controls {
    display:flex;
    justify-content:center;
    align-items:center;
    gap:26px;
    font-size:30px;
    margin-bottom:8px;
}
.ctrl-btn {
    background:none;
    border:none;
    color:white;
    cursor:pointer;
}

/* PROGRESS */
.progress {
    display:flex;
    align-items:center;
    gap:8px;
    font-size:12px;
    color:#aaa;
}
.progress input[type=range] {
    flex:1;
    max-width:65%;
    accent-color:white;
}

/* SPA VIEWS */
.view { display:none; }
.view.active { display:block; }

/* PLAYLIST GRID */
.playlists-grid {
    display:grid;
    grid-template-columns:repeat(2,1fr);
    gap:14px;
}
.playlist-card {
    background:#1a1a1a;
    border-radius:14px;
    aspect-ratio:1/1;
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:600;
    cursor:pointer;
}
.playlist-card:hover {
    background:#222;
}

#audio-player { display:none; }
</style>
</head>

<body>

<div class="header">
    <div class="header-title">Telegram Music Cloud</div>
    <div class="search-box">
        <input type="text" placeholder="–ü–æ–∏—Å–∫...">
    </div>
</div>

<div class="layout">
    <div class="songs-container">

        <div class="library-menu">
            <button class="menu-btn active" id="btn-library">üéµ –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞</button>
            <button class="menu-btn" id="btn-playlists">üìÇ –ü–ª–µ–π–ª–∏—Å—Ç—ã</button>
        </div>

        <!-- LIBRARY -->
        <div id="library-view" class="view active">
            <div id="track-list"></div>
        </div>

        <!-- PLAYLISTS -->
        <div id="playlists-view" class="view">
            <div class="playlists-grid">
                <div class="playlist-card" id="create-playlist">‚ûï –ù–æ–≤—ã–π</div>

                <div class="playlist-card">‚ù§Ô∏è –ò–∑–±—Ä–∞–Ω–Ω–æ–µ</div>
            </div>
        </div>

    </div>
</div>

<div class="mini-player hidden" id="mini-player">
    <div class="mini-title" id="mini-title"></div>

    <div class="controls">
        <button class="ctrl-btn" id="repeat">üîÅ</button>
        <button class="ctrl-btn" id="prev">‚èÆ</button>
        <button class="ctrl-btn" id="play">‚ñ∂</button>
        <button class="ctrl-btn" id="next">‚è≠</button>
        <button class="ctrl-btn" id="mini-more">‚ãØ</button>
    </div>

    <div class="progress">
        <span id="current">0:00</span>
        <input type="range" id="progress" value="0" min="0" step="0.1">
        <span id="duration">0:00</span>
    </div>
</div>

<div id="context-menu" class="context-menu hidden">
    <button id="delete-track">üóë –£–¥–∞–ª–∏—Ç—å</button>
    <button>‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤ –ø–ª–µ–π–ª–∏—Å—Ç</button>
</div>

<audio id="audio-player" preload="metadata"></audio>

<script>
const tg = window.Telegram.WebApp;
tg.ready();
tg.expand();

const apiBase = "https://telegram-music-player-uh5o.onrender.com";
const audio = document.getElementById("audio-player");

const trackListDiv = document.getElementById("track-list");
const miniTitle = document.getElementById("mini-title");
const playBtn = document.getElementById("play");
const prevBtn = document.getElementById("prev");
const nextBtn = document.getElementById("next");
const repeatBtn = document.getElementById("repeat");
const miniMore = document.getElementById("mini-more");

const progress = document.getElementById("progress");
const currentEl = document.getElementById("current");
const durationEl = document.getElementById("duration");
const miniPlayer = document.getElementById("mini-player");

const contextMenu = document.getElementById("context-menu");
const deleteBtn = document.getElementById("delete-track");

repeatBtn.style.opacity = "0.4";

let tracks = [];
let currentIndex = -1;
let repeat = false;
let contextTrackId = null;

const linkCache = new Map();

/* SPA NAV */
const btnLibrary = document.getElementById("btn-library");
const btnPlaylists = document.getElementById("btn-playlists");
const libraryView = document.getElementById("library-view");
const playlistsView = document.getElementById("playlists-view");

btnLibrary.onclick = () => switchView("library");
btnPlaylists.onclick = () => switchView("playlists");

function switchView(v){
    libraryView.classList.toggle("active", v==="library");
    playlistsView.classList.toggle("active", v==="playlists");
    btnLibrary.classList.toggle("active", v==="library");
    btnPlaylists.classList.toggle("active", v==="playlists");

    if (v === "playlists") {
        loadPlaylists();
    }
}


/* STREAM */
async function getStreamUrl(id){
    if(linkCache.has(id)) return linkCache.get(id);
    const r = await fetch(`${apiBase}/api/tracks/play/${id}`, {
        headers:{ "X-TG-INIT-DATA": tg.initData }
    });
    const data = await r.json();
    linkCache.set(id, data.streamUrl);
    return data.streamUrl;
}

async function loadTracks(){
    const r = await fetch(`${apiBase}/api/tracks`, {
        headers:{ "X-TG-INIT-DATA": tg.initData }
    });
    tracks = await r.json();
    renderTracks();
}

function renderTracks(){
    trackListDiv.innerHTML="";
    tracks.forEach((t,i)=>{
        const div=document.createElement("div");
        div.className="track-item";
        div.innerHTML=`
            <span>${i+1}</span>
            <div>
                <div class="track-title">${t.originalName}</div>
                <div class="track-artist">${t.performer||"Unknown"}</div>
            </div>
            <button class="play-btn">${i===currentIndex&&!audio.paused?"‚è∏":"‚ñ∂"}</button>
            <button class="more-btn">‚ãØ</button>
        `;
        div.onclick=()=>playTrack(i);
        div.querySelector(".play-btn").onclick=e=>{e.stopPropagation();playTrack(i);}
        div.querySelector(".more-btn").onclick=e=>{e.stopPropagation();openContextMenu(e.currentTarget,t.id);}
        trackListDiv.appendChild(div);
    });
}

async function playTrack(i){
    currentIndex=i;
    audio.src=await getStreamUrl(tracks[i].id);
    await audio.play();
    miniTitle.innerText=tracks[i].originalName;
    playBtn.innerText="‚è∏";
    miniPlayer.classList.remove("hidden");
    renderTracks();
}

playBtn.onclick=()=>{audio.paused?audio.play():audio.pause();renderTracks();}
nextBtn.onclick=()=>currentIndex<tracks.length-1&&playTrack(currentIndex+1);
prevBtn.onclick=()=>currentIndex>0&&playTrack(currentIndex-1);
repeatBtn.onclick=()=>{repeat=!repeat;audio.loop=repeat;repeatBtn.style.opacity=repeat?"1":"0.4";}

audio.onended=()=>!repeat&&nextBtn.click();
audio.onloadedmetadata=()=>{progress.max=audio.duration;durationEl.innerText=format(audio.duration);}
audio.ontimeupdate=()=>{progress.value=audio.currentTime;currentEl.innerText=format(audio.currentTime);}
progress.oninput=()=>audio.currentTime=progress.value;

/* CONTEXT */
function openContextMenu(btn,id){
    contextTrackId=id;
    const r=btn.getBoundingClientRect();
    contextMenu.style.top=`${r.bottom+6}px`;
    contextMenu.style.left=`${r.right-200}px`;
    contextMenu.classList.remove("hidden");
}
document.addEventListener("click",()=>contextMenu.classList.add("hidden"));
deleteBtn.onclick=async()=>{
    await fetch(`${apiBase}/api/tracks/${contextTrackId}`,{method:"DELETE"});
    loadTracks();
};

function format(t){
    const m=Math.floor(t/60);
    const s=Math.floor(t%60).toString().padStart(2,"0");
    return `${m}:${s}`;
}
async function loadPlaylists() {
    const r = await fetch(`${apiBase}/api/playlists`, {
        headers: { "X-TG-INIT-DATA": tg.initData }
    });
    const playlists = await r.json();
    renderPlaylists(playlists);
}

function renderPlaylists(playlists) {
    playlistsView.innerHTML = `
        <div class="playlists-grid">
            <div class="playlist-card" id="create-playlist">‚ûï –ù–æ–≤—ã–π</div>
            ${playlists.map(p => `
                <div class="playlist-card">${p.name}</div>
            `).join("")}
        </div>
    `;

    document.getElementById("create-playlist").onclick = createPlaylist;
}

async function createPlaylist() {
    const name = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ –ø–ª–µ–π–ª–∏—Å—Ç–∞");
    if (!name) return;

    await fetch(`${apiBase}/api/playlists`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-TG-INIT-DATA": tg.initData
        },
        body: JSON.stringify({ name })
    });

    loadPlaylists();
}

loadTracks();
</script>

</body>
</html>
